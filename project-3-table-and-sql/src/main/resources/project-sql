-- Case 1

drop table if EXISTS user_behavior;

CREATE TABLE user_behavior (
    user_id BIGINT,
    item_id BIGINT,
    category_id BIGINT,
    behavior STRING,
    ts_ms BIGINT,
    ts AS TO_TIMESTAMP_LTZ(ts_ms, 3),
    WATERMARK FOR ts AS ts - INTERVAL '5' SECOND
)
WITH (
    'connector' = 'kafka',
    'topic' = 'user_behavior',
    'properties.bootstrap.servers' = 'localhost:9092',
    'scan.startup.mode' = 'latest-offset',
    'format' = 'json'
);



-- bin/kafka-topics.sh --create \
--     --topic user_behavior \
--     --bootstrap-server localhost:9092 \
--     --partitions 3 \
--     --replication-factor 1

-- bin/kafka-topics.sh --delete --topic user_behavior --bootstrap-server localhost:9092 


CREATE TABLE buy_cnt_per_hour (
    hour_of_day BIGINT,
    buy_cnt BIGINT
)
WITH (
    'connector' = 'elasticsearch-7',
    'hosts' = 'http://localhost:9200',
    'index' = 'buy_cnt_per_hour',
    'sink.bulk-flush.max-actions' = '1',
    'format' = 'json'
);

INSERT INTO buy_cnt_per_hour
SELECT 
    HOUR(TUMBLE_START(ts, INTERVAL '1' HOUR)) AS hour_of_day,
    COUNT(*) AS buy_cnt
FROM user_behavior
WHERE behavior = 'buy'
GROUP BY TUMBLE(ts, INTERVAL '1' HOUR);


-- Case 2


CREATE TABLE cumulative_uv (
    time_str STRING,
    uv BIGINT,
    PRIMARY KEY (time_str) NOT ENFORCED
)
WITH (
    'connector' = 'elasticsearch-7',
    'hosts' = 'http://localhost:9200',
    'index' = 'cumulative_uv',
    'document-id.key-delimiter' = '_',
    'sink.bulk-flush.max-actions' = '1',
    'format' = 'json'
);




CREATE VIEW uv_per_10min AS
SELECT
    DATE_FORMAT(window_start, 'HH:mm') AS time_str,
    COUNT(DISTINCT user_id) AS uv
FROM TABLE(
    TUMBLE(TABLE user_behavior, DESCRIPTOR(ts), INTERVAL '10' MINUTES)
)
GROUP BY window_start, window_end;


INSERT INTO cumulative_uv
SELECT time_str, MAX(uv)
FROM uv_per_10min
GROUP BY time_str;


-- Case 3

CREATE TABLE category_dim (
    sub_category_id BIGINT,  
    parent_category_id BIGINT 
) WITH (
    'connector.type' = 'jdbc',
    'connector.url' = 'jdbc:mysql://node01:3306/flink',
    'connector.table' = 'category',
    'connector.driver' = 'com.mysql.jdbc.Driver',
    'connector.username' = 'root',
    'connector.password' = '123456',
    'connector.lookup.cache.max-rows' = '5000',
    'connector.lookup.cache.ttl' = '10min'
);

CREATE TABLE top_category (
    category_name STRING, 
    buy_cnt BIGINT 
) WITH (
    'connector.type' = 'elasticsearch',
    'connector.version' = '7',
    'connector.hosts' = 'http://localhost:9200',
    'connector.index' = 'top_category',
    'connector.document-type' = 'user_behavior',
    'format.type' = 'json',
    'update-mode' = 'upsert'
);


CREATE VIEW rich_user_behavior AS
SELECT U.user_id, U.item_id, U.behavior, 
  CASE C.parent_category_id
    WHEN 1 THEN '服饰鞋包'
    WHEN 2 THEN '家装家饰'
    WHEN 3 THEN '家电'
    WHEN 4 THEN '美妆'
    WHEN 5 THEN '母婴'
    WHEN 6 THEN '3C数码'
    WHEN 7 THEN '运动户外'
    WHEN 8 THEN '食品'
    ELSE '其他'
  END AS category_name
FROM user_behavior AS U LEFT JOIN category_dim FOR SYSTEM_TIME AS OF U.proctime AS C
ON U.category_id = C.sub_category_id;


INSERT INTO top_category
SELECT category_name, COUNT(*) buy_cnt
FROM rich_user_behavior
WHERE behavior = 'buy'
GROUP BY category_name;


